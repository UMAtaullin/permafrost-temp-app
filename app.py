import streamlit as st
import pandas as pd
from model import PermafrostModel

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
st.set_page_config(
    page_title="–¢–µ—Ä–º–æ–º–µ—Ç—Ä–∏—è –º–µ—Ä–∑–ª—ã—Ö –≥—Ä—É–Ω—Ç–æ–≤", page_icon="üßä", layout="wide"
)

st.title("üßä –ü—Ä–æ–≥–Ω–æ–∑ —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä –≤ –º–µ—Ä–∑–ª—ã—Ö –≥—Ä—É–Ω—Ç–æ–≤")
st.write("–†–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è —Å –º–Ω–æ–≥–æ—Å–ª–æ–π–Ω–æ—Å—Ç—å—é –∏ —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–Ω—ã–º–∏ –≥—Ä–∞–¥–∞—Ü–∏—è–º–∏")

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –º–æ–¥–µ–ª–∏
if "model" not in st.session_state:
    st.session_state.model = PermafrostModel()

# –ë–æ–∫–æ–≤–∞—è –ø–∞–Ω–µ–ª—å - —Ç–µ–ø–µ—Ä—å –¥–ª—è —Å–ª–æ—ë–≤ –≥—Ä—É–Ω—Ç–∞
with st.sidebar:
    st.header("–ì–µ–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π —Ä–∞–∑—Ä–µ–∑")

    st.subheader("–°–ª–æ–π 1")
    lithology1 = st.selectbox("–ì—Ä—É–Ω—Ç —Å–ª–æ—è 1", ["—Ç–æ—Ä—Ñ", "—Å—É–≥–ª–∏–Ω–æ–∫", "—Å—É–ø–µ—Å—å", "–ø–µ—Å–æ–∫"])
    depth1 = st.number_input("–ú–æ—â–Ω–æ—Å—Ç—å —Å–ª–æ—è 1 (–º)", 0.0, 20.0, 1.5, 0.5)

    st.subheader("–°–ª–æ–π 2")
    lithology2 = st.selectbox("–ì—Ä—É–Ω—Ç —Å–ª–æ—è 2", ["—Ç–æ—Ä—Ñ", "—Å—É–≥–ª–∏–Ω–æ–∫", "—Å—É–ø–µ—Å—å", "–ø–µ—Å–æ–∫"])
    depth2 = st.number_input("–ú–æ—â–Ω–æ—Å—Ç—å —Å–ª–æ—è 2 (–º)", 0.0, 20.0, 3.5, 0.5)

    st.subheader("–°–ª–æ–π 3")
    lithology3 = st.selectbox("–ì—Ä—É–Ω—Ç —Å–ª–æ—è 3", ["—Ç–æ—Ä—Ñ", "—Å—É–≥–ª–∏–Ω–æ–∫", "—Å—É–ø–µ—Å—å", "–ø–µ—Å–æ–∫"])
    depth3 = st.number_input("–ú–æ—â–Ω–æ—Å—Ç—å —Å–ª–æ—è 3 (–º)", 0.0, 20.0, 3.0, 0.5)

    st.header("–ö–ª–∏–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã")
    surface_temp = st.number_input(
        "–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ –ø–æ–≤–µ—Ä—Ö–Ω–æ—Å—Ç–∏ (¬∞C)", -30.0, 20.0, -5.0, 0.5
    )
    season = st.selectbox("–í—Ä–µ–º—è –≥–æ–¥–∞", ["–∑–∏–º–∞", "–≤–µ—Å–Ω–∞", "–ª–µ—Ç–æ", "–æ—Å–µ–Ω—å"])

# –°–æ–∑–¥–∞—ë–º –æ–ø–∏—Å–∞–Ω–∏–µ —Ä–∞–∑—Ä–µ–∑–∞
layers = [
    {"lithology": lithology1, "depth_to": depth1},
    {"lithology": lithology2, "depth_to": depth1 + depth2},
    {"lithology": lithology3, "depth_to": depth1 + depth2 + depth3},
]

# –û—Å–Ω–æ–≤–Ω–∞—è –æ–±–ª–∞—Å—Ç—å
st.header("–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–Ω—ã–π –ø—Ä–æ—Ñ–∏–ª—å —Å —É—á—ë—Ç–æ–º —Å–ª–æ–∏—Å—Ç–æ—Å—Ç–∏")

# –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –≥–ª—É–±–∏–Ω—ã –¥–ª—è —Ä–∞—Å—á—ë—Ç–∞
standard_depths = [0, 0.5, 1, 1.5, 2, 2.5, 3, 3.5, 4, 4.5, 5, 6, 7, 8, 9, 10, 12, 14]


# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –≥—Ä—É–Ω—Ç–∞ –Ω–∞ –∑–∞–¥–∞–Ω–Ω–æ–π –≥–ª—É–±–∏–Ω–µ
def get_lithology_at_depth(depth, layers):
    for layer in layers:
        if depth <= layer["depth_to"]:
            return layer["lithology"]
    return layers[-1][
        "lithology"
    ]  # –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–π –≥—Ä—É–Ω—Ç –µ—Å–ª–∏ –≥–ª—É–±–∏–Ω–∞ –±–æ–ª—å—à–µ –≤—Å–µ—Ö —Å–ª–æ—ë–≤


# –°–æ–∑–¥–∞—ë–º —Ç–∞–±–ª–∏—Ü—É —Å –ø—Ä–æ–≥–Ω–æ–∑–∞–º–∏
data = []
for depth in standard_depths:
    if depth <= layers[-1]["depth_to"]:  # —Ç–æ–ª—å–∫–æ –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö –∑–∞–¥–∞–Ω–Ω—ã—Ö —Å–ª–æ—ë–≤
        lith_at_depth = get_lithology_at_depth(depth, layers)
        predicted_temp = st.session_state.model.predict_temperature(
            depth, lith_at_depth, surface_temp, season
        )

        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≥—Ä—É–Ω—Ç–∞ (–¥–ª—è –æ—Å–Ω–æ–≤–Ω—ã—Ö —Ç–∏–ø–æ–≤ –∏–∑ —Ç–∞–±–ª–∏—Ü—ã)
        ground_type_map = {
            "–ø–µ—Å–æ–∫": "–ø–µ—Å–æ–∫ —Å—Ä–µ–¥–Ω–µ–π –∫—Ä—É–ø–Ω–æ—Å—Ç–∏",
            "—Å—É–ø–µ—Å—å": "—Å—É–ø–µ—Å—å",
            "—Å—É–≥–ª–∏–Ω–æ–∫": "—Å—É–≥–ª–∏–Ω–æ–∫",
            "—Ç–æ—Ä—Ñ": "—Å—É–≥–ª–∏–Ω–æ–∫",  # –ø—Ä–∏–±–ª–∏–∑–∏—Ç–µ–ª—å–Ω–æ –¥–ª—è —Ç–æ—Ä—Ñ–∞
        }

        ground_type = ground_type_map.get(lith_at_depth, "—Å—É–≥–ª–∏–Ω–æ–∫")
        ground_state = st.session_state.model.get_ground_state(
            predicted_temp, ground_type
        )

        data.append(
            {
                "–ì–ª—É–±–∏–Ω–∞ (–º)": depth,
                "–ì—Ä—É–Ω—Ç": lith_at_depth,
                "–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ (¬∞C)": predicted_temp,
                "–°–æ—Å—Ç–æ—è–Ω–∏–µ": ground_state,
            }
        )

df = pd.DataFrame(data)
st.dataframe(df, use_container_width=True)

# –í–∏–∑—É–∞–ª–∏–∑–∏—Ä—É–µ–º —Ä–∞–∑—Ä–µ–∑
st.header("–í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –≥–µ–æ–ª–æ–≥–∏—á–µ—Å–∫–æ–≥–æ —Ä–∞–∑—Ä–µ–∑–∞")
st.write(f"**–°–ª–æ–π 1:** {lithology1} (0.0 - {depth1} –º)")
st.write(f"**–°–ª–æ–π 2:** {lithology2} ({depth1} - {depth1 + depth2} –º)")
st.write(f"**–°–ª–æ–π 3:** {lithology3} ({depth1 + depth2} - {layers[-1]['depth_to']} –º)")

# –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –ø–æ —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–Ω—ã–º –≥—Ä–∞–¥–∞—Ü–∏—è–º
st.header("–°–ø—Ä–∞–≤–∫–∞ –ø–æ —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–Ω—ã–º –≥—Ä–∞–¥–∞—Ü–∏—è–º")
st.write(
    """
- **–¢–≤—ë—Ä–¥–æ–º—ë—Ä–∑–ª—ã–π**: —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ –Ω–∏–∂–µ –≥—Ä–∞–Ω–∏—Ü—ã –ø–ª–∞—Å—Ç–∏—á–Ω–æ—Å—Ç–∏
- **–ü–ª–∞—Å—Ç–∏—á–Ω–æ–º—ë—Ä–∑–ª—ã–π**: —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ –≤ –∏–Ω—Ç–µ—Ä–≤–∞–ª–µ –ø–ª–∞—Å—Ç–∏—á–Ω–æ—Å—Ç–∏  
- **–û—Ö–ª–∞–∂–¥—ë–Ω–Ω—ã–π**: –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω–∞—è —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞, –Ω–æ –≤—ã—à–µ –ø–ª–∞—Å—Ç–∏—á–Ω–æ—Å—Ç–∏
- **–¢–∞–ª—ã–π**: –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–∞—è —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞
"""
)
